<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPA Tracker - Smart Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-blue: #f8fbff; --accent-blue: #c5e1ff; --deep-blue: #6396e3;
        --soft-blue: #ebf4ff; --white: #ffffff; --text-main: #5a718a;
        --text-sub: #8ea4bb; --border-color: #d8e9ff; --danger: #ff4d6d;
    }
    body { font-family: 'Quicksand', sans-serif; background-color: var(--bg-blue); color: var(--text-main); padding: 20px; margin: 0; }
    .container { max-width: 1000px; margin: auto; }
    
    #auth-container { display: flex; justify-content: center; align-items: center; height: 90vh; }
    .login-card { background: var(--white); padding: 40px; border-radius: 40px; box-shadow: 0 10px 30px rgba(99, 150, 227, 0.1); width: 100%; max-width: 350px; text-align: center; border: 2px solid var(--accent-blue); }
    .login-card input { width: 100%; padding: 12px 15px; margin: 10px 0; border-radius: 15px; border: 1.5px solid var(--border-color); font-family: 'Quicksand'; box-sizing: border-box; outline: none; }

    .header-nav { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-bottom: 20px; }
    .account-email { font-weight: 700; font-size: 0.9em; color: var(--deep-blue); }
    .btn-logout { background: #ffe4e9; color: #e91e63; border: none; padding: 5px 15px; border-radius: 12px; cursor: pointer; font-family: 'Quicksand'; font-weight: 700; font-size: 0.8em; }

    .academic-frame { border: 2px solid var(--accent-blue); border-radius: 40px; padding: 25px; position: relative; margin-bottom: 40px; background: white; text-align: center; }
    .academic-title { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); background: white; padding: 0 20px; font-weight: 800; color: var(--deep-blue); letter-spacing: 1px; font-size: 1.2em; }
    
    .view-selector { margin-bottom: 20px; border: 1.5px solid var(--accent-blue); padding: 8px 15px; border-radius: 15px; font-family: 'Quicksand'; font-weight: 700; color: var(--deep-blue); outline: none; background: var(--bg-blue); cursor: pointer; }

    .result-section { display: flex; justify-content: center; gap: 20px; margin-bottom: 5px; }
    .result-box { background: var(--soft-blue); border: 2px dashed var(--accent-blue); border-radius: 25px; padding: 12px 25px; text-align: center; min-width: 160px; }
    .result-box h4 { margin: 0; font-size: 0.75em; text-transform: uppercase; color: var(--text-sub); }
    .result-box .gpa-val { font-size: 2.2em; font-weight: 700; color: var(--deep-blue); line-height: 1.1; }
    
    .semester-block { background: white; border-radius: 30px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .course-item { border: 1px solid #edf3f9; border-radius: 20px; margin-bottom: 15px; overflow: hidden; background: #fff; }
    .course-top { padding: 15px 25px; cursor: pointer; }
    .course-summary-bar { display: flex; justify-content: space-between; background: var(--soft-blue); padding: 12px 25px; border-radius: 15px; margin-top: 10px; font-size: 0.9em; font-weight: 700; }

    .task-row { display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr 45px; gap: 10px; padding: 6px 0; align-items: center; }
    .task-row input { border: 1.5px solid var(--border-color); border-radius: 18px; padding: 10px; font-family: 'Quicksand'; font-weight: 600; font-size: 0.85em; outline: none; }

    .btn { border: none; border-radius: 15px; padding: 10px 20px; font-weight: 700; cursor: pointer; font-family: 'Quicksand'; transition: 0.3s; }
    .btn-main { background: var(--deep-blue); color: white; }
    .btn-danger { background: #ffe4e9; color: var(--danger); font-size: 0.8em; }
    .del-btn { color: #ccc; cursor: pointer; font-weight: 800; }
    .del-btn:hover { color: var(--danger); }
    .hidden { display: none !important; }
    .arrow { display: inline-block; transition: transform 0.3s; margin-right: 8px; color: var(--deep-blue); }
    .collapsed-icon { transform: rotate(-90deg); }
    
    .editable-text:hover { text-decoration: underline; color: #333; }

    .scale-editor { background: #fff; border: 1.5px dashed var(--accent-blue); border-radius: 20px; padding: 20px; margin: 15px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 15px; }
    .scale-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75em; font-weight: 700; }
    .scale-item input { width: 100%; border-radius: 10px; border: 1px solid var(--border-color); padding: 8px; text-align: center; font-family: 'Quicksand'; margin-top: 5px; }
</style>
</head>
<body>

<div class="container">
    <div id="auth-container">
        <div class="login-card">
            <h2 id="auth-title">Login</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button class="btn btn-main" style="width: 100%; margin-top: 15px;" id="auth-btn">Sign In</button>
            <p style="font-size: 0.85em; margin-top: 20px;">
                <span id="toggle-text">Don't have an account?</span> 
                <span id="toggle-auth" style="color: var(--deep-blue); cursor: pointer; font-weight: 700;">Sign Up</span>
            </p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="header-nav">
            <span class="account-email" id="user-email-header">loading...</span>
            <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>

        <div class="academic-frame">
            <div class="academic-title">ACADEMIC RESULTS</div>
            
            <select id="view-mode-selector" class="view-selector" onchange="renderAll()">
                <option value="all">All Semesters (Cumulative)</option>
            </select>

            <div class="result-section">
                <div class="result-box"><h4>GPA</h4><div class="gpa-val" id="cum-gpa">0.00</div></div>
                <div class="result-box"><h4>What-If GPA</h4><div class="gpa-val" id="cum-if-gpa">0.00</div></div>
            </div>
            <div style="font-weight: 700; color: #a0b1c5; margin-top: 10px;">
                Courses: <span id="total-courses">0</span> | Credits: <span id="total-credits">0</span>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 25px; display: flex; justify-content: center; gap: 10px;">
            <button class="btn btn-main" onclick="window.addSemester()">+ New Semester</button>
            <button class="btn btn-danger" onclick="window.clearAllData()">X Clear All Data</button>
        </div>
        <div id="semesterContainer"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDUAIYRSUtCHmS7s8KyEbK4Mht3CkfYGwk",
        authDomain: "mygpatracker.firebaseapp.com",
        databaseURL: "https://mygpatracker-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mygpatracker",
        storageBucket: "mygpatracker.firebasestorage.app",
        messagingSenderId: "875336375746",
        appId: "1:875336375746:web:e5d0f4951a83b85dd70a5b",
        measurementId: "G-S6E4TDC4LP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let semesters = [];
    let currentUser = null;
    let isLoginMode = true;

    // Định nghĩa thứ tự hiển thị cố định để tránh trình duyệt tự sắp xếp sai
    const GRADE_ORDER = ['A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D'];
    const DEFAULT_SCALE = {'A':89.5, 'A-':84.5, 'B+':79.5, 'B':74.5, 'B-':69.5, 'C+':64.5, 'C':59.5, 'C-':54.5, 'D+':49.5, 'D':44.5};
    const gradePoints = {'A':4.0,'A-':3.7,'B+':3.3,'B':3.0,'B-':2.7,'C+':2.3,'C':2.0,'C-':1.7,'D+':1.3,'D':1.0,'F':0};

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-email-header').innerText = user.email;
            onValue(ref(db, `users/${user.uid}/data`), snap => { semesters = snap.val() || []; renderAll(); });
        } else {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
    });

    document.getElementById('toggle-auth').onclick = () => {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('auth-btn').innerText = isLoginMode ? 'Sign In' : 'Create Account';
        document.getElementById('toggle-auth').innerText = isLoginMode ? "Sign Up" : "Login";
    };

    document.getElementById('auth-btn').onclick = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            if (isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
            else await createUserWithEmailAndPassword(auth, email, pass);
        } catch (e) { alert(e.message); }
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    const sync = () => currentUser && set(ref(db, `users/${currentUser.uid}/data`), semesters);
    
    window.clearAllData = () => { if(confirm("Delete ALL data?")) { semesters = []; sync(); } };
    window.delSem = (sId) => { if(confirm("Delete semester?")) { semesters = semesters.filter(s => s.id !== sId); sync(); } };
    window.delCourse = (sId, cId) => { if(confirm("Delete course?")) { const s = semesters.find(x => x.id === sId); s.courses = s.courses.filter(c => c.id !== cId); sync(); } };
    window.delCat = (sId, cId, catId) => { if(confirm("Delete component?")) { const c = semesters.find(x => x.id === sId).courses.find(y => y.id === cId); c.categories = c.categories.filter(z => z.id !== catId); sync(); } };
    window.delTask = (sId, cId, catId, tId) => { const ca = semesters.find(x => x.id === sId).courses.find(y => y.id === cId).categories.find(z => z.id === catId); ca.tasks = ca.tasks.filter(t => t.id !== tId); sync(); };

    window.addSemester = () => { const n = prompt("Semester Name: (e.g. Year 1 Spring)"); if(n) { semesters.push({ id: Date.now(), name: n, courses: [], isCollapsed: false }); sync(); } };
    window.addCourse = (sId) => {
        const n = prompt("Course Name: (e.g. Calculus I)"), c = parseFloat(prompt("Credits: (e.g. 3)"));
        if(n) { const sem = semesters.find(x => x.id === sId); (sem.courses = sem.courses || []).push({ id: Date.now(), name: n, credits: c || 0, categories: [], isCollapsed: false, showScale: false, thres: {...DEFAULT_SCALE} }); sync(); }
    };

    window.renameSem = (sId) => {
        const s = semesters.find(x => x.id === sId);
        const n = prompt("Edit Semester Name: (e.g. Year 1 Spring)", s.name);
        if(n) { s.name = n; sync(); }
    };
    
    window.editCourse = (sId, cId) => {
        const c = semesters.find(x => x.id === sId).courses.find(y => y.id === cId);
        const n = prompt("Edit Course Name: (e.g. Calculus I)", c.name);
        const cr = prompt("Edit Credits: (e.g. 3)", c.credits);
        if(n) c.name = n;
        if(cr) c.credits = parseFloat(cr) || 0;
        sync();
    };

    window.addCat = (sId, cId) => {
        const n = prompt("Component:"), w = parseFloat(prompt("Weight %:"));
        if(n && w) { const course = semesters.find(s => s.id === sId).courses.find(c => c.id === cId); (course.categories = course.categories || []).push({ id: Date.now(), name: n, weight: w, tasks: [], isCollapsed: false }); sync(); }
    };
    window.addTask = (sId, cId, catId) => {
        const cat = semesters.find(s => s.id === sId).courses.find(c => c.id === cId).categories.find(ca => ca.id === catId);
        (cat.tasks = cat.tasks || []).push({ id: Date.now(), label: '', score: 0, maxScore: 100, scoreIf: null }); sync();
    };

    window.updateT = (sId, cId, catId, tId, f, v) => {
        const t = semesters.find(s => s.id === sId).courses.find(c => c.id === cId).categories.find(ca => ca.id === catId).tasks.find(x => x.id === tId);
        if(f === 'label') t[f] = v; else t[f] = (v === '' || v === null) ? (f==='scoreIf' ? null : 0) : parseFloat(v); sync();
    };

    window.updateScale = (sId, cId, grade, val) => { semesters.find(s => s.id === sId).courses.find(c => c.id === cId).thres[grade] = parseFloat(val) || 0; sync(); };
    window.tog = (type, sId, cId, catId) => {
        let obj;
        if(type==='sem') obj = semesters.find(x => x.id === sId);
        else if(type==='course') obj = semesters.find(s => s.id === sId).courses.find(c => c.id === cId);
        else if(type==='cat') obj = semesters.find(s => s.id === sId).courses.find(c => c.id === cId).categories.find(ca => ca.id === catId);
        else if(type==='scale') obj = semesters.find(s => s.id === sId).courses.find(c => c.id === cId);
        if(type==='scale') obj.showScale = !obj.showScale; else obj.isCollapsed = !obj.isCollapsed;
        renderAll();
    };

    const getL = (p, th) => {
        const sorted = Object.keys(th || DEFAULT_SCALE).sort((a,b) => (th || DEFAULT_SCALE)[b]-(th || DEFAULT_SCALE)[a]);
        for(let k of sorted) if(p >= (th || DEFAULT_SCALE)[k]) return k; return 'F';
    };

    window.renderAll = function() {
        const container = document.getElementById('semesterContainer');
        const selector = document.getElementById('view-mode-selector');
        const currentView = selector.value;
        
        const savedVal = selector.value;
        selector.innerHTML = '<option value="all">All Semesters (Cumulative)</option>';
        semesters.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id; opt.innerText = s.name;
            selector.appendChild(opt);
        });
        selector.value = savedVal;

        container.innerHTML = '';
        let totalGPA_Sum=0, totalIfGPA_Sum=0, totalCr=0, tCourses=0;

        semesters.forEach(sem => {
            const semDiv = document.createElement('div'); semDiv.className = 'semester-block';
            semDiv.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; color:var(--deep-blue); cursor:pointer">
                    <span onclick="window.tog('sem', ${sem.id})"><span class="arrow ${sem.isCollapsed?'collapsed-icon':''}">▼</span></span>
                    <span class="editable-text" onclick="window.renameSem(${sem.id})">${sem.name}</span>
                </h2>
                <div style="display:flex; gap:12px; align-items:center"><button class="btn btn-main" style="padding:5px 12px; font-size:0.8em" onclick="window.addCourse(${sem.id})">+ Course</button><span class="del-btn" onclick="window.delSem(${sem.id})">X</span></div></div>
                <div id="c-list-${sem.id}" class="${sem.isCollapsed?'hidden':''}" style="margin-top:20px"></div>`;
            container.appendChild(semDiv);

            (sem.courses || []).forEach(course => {
                let actScore_Pct=0, ifScore_Pct=0, weightSum=0;
                (course.categories || []).forEach(cat => {
                    let s_act=0, s_if=0, m_total=0;
                    (cat.tasks || []).forEach(t => { 
                        s_act += (t.score || 0); m_total += (t.maxScore || 100); 
                        s_if += (t.scoreIf !== null && t.scoreIf !== undefined) ? t.scoreIf : (t.score || 0); 
                    });
                    const catPct = (m_total > 0 ? (s_act/m_total)*100 : 0);
                    cat.lastScore = catPct * (cat.weight/100); actScore_Pct += cat.lastScore;
                    ifScore_Pct += (m_total > 0 ? (s_if/m_total)*100 : 0) * (cat.weight/100); weightSum += cat.weight;
                });
                const finalAct = weightSum > 0 ? actScore_Pct / (weightSum/100) : 0;
                const finalIf = weightSum > 0 ? ifScore_Pct / (weightSum/100) : 0;
                const letterAct = getL(finalAct, course.thres); const pointAct = gradePoints[letterAct] || 0;
                const letterIf = getL(finalIf, course.thres); const pointIf = gradePoints[letterIf] || 0;
                
                if (currentView === "all" || currentView == sem.id) {
                    tCourses++;
                    totalGPA_Sum += pointAct * course.credits;
                    totalIfGPA_Sum += pointIf * course.credits;
                    totalCr += course.credits;
                }

                const cDiv = document.createElement('div'); cDiv.className = 'course-item';
                cDiv.innerHTML = `<div class="course-top">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <strong style="cursor:pointer">
                            <span onclick="window.tog('course', ${sem.id}, ${course.id})"><span class="arrow ${course.isCollapsed?'collapsed-icon':''}">▼</span></span>
                            <span class="editable-text" onclick="window.editCourse(${sem.id}, ${course.id})">${course.name} (${course.credits} credits)</span>
                        </strong>
                        <div style="display:flex; gap:12px; align-items:center"><button class="btn" style="background:#f0f7ff; color:var(--deep-blue); font-size:0.7em; padding:4px 8px" onclick="window.tog('scale', ${sem.id}, ${course.id})">⚙️ Scale</button><span class="del-btn" onclick="window.delCourse(${sem.id}, ${course.id})">X</span></div>
                    </div>
                    <div class="course-summary-bar" onclick="window.tog('course', ${sem.id}, ${course.id})">
                        <div><span style="font-size:0.7em; color:var(--text-sub)">ACTUAL</span><br>${finalAct.toFixed(1)}% | ${letterAct} | ${pointAct.toFixed(2)}</div>
                        <div style="text-align:right"><span style="font-size:0.7em; color:var(--text-sub)">WHAT-IF</span><br>${finalIf.toFixed(1)}% | ${letterIf} | ${pointIf.toFixed(2)}</div>
                    </div>
                </div>
                <div class="${course.isCollapsed?'hidden':''}" style="padding:0 20px 20px;">
                    <div class="scale-editor ${course.showScale ? '' : 'hidden'}">
                        ${GRADE_ORDER.map(k => `
                            <div class="scale-item">
                                <span>${k}</span>
                                <input type="number" step="0.1" value="${(course.thres || DEFAULT_SCALE)[k]}" onchange="window.updateScale(${sem.id}, ${course.id}, '${k}', this.value)">
                            </div>`).join('')}
                    </div>
                    <div id="cat-list-${course.id}"></div>
                    <button class="btn btn-main" style="background:#f0f7ff; color:var(--deep-blue); font-size:0.75em; margin-top:10px" onclick="window.addCat(${sem.id}, ${course.id})">+ Component</button>
                </div>`;
                document.getElementById(`c-list-${sem.id}`).appendChild(cDiv);

                (course.categories || []).forEach(cat => {
                    const catDiv = document.createElement('div');
                    catDiv.innerHTML = `<div style="display:flex; justify-content:space-between; margin-top:15px; cursor:pointer" onclick="window.tog('cat', ${sem.id}, ${course.id}, ${cat.id})"><span style="font-weight:700; font-size:0.9em"><span class="arrow ${cat.isCollapsed?'collapsed-icon':''}">▼</span>${cat.name} (${cat.weight}%) - <span style="color:var(--deep-blue)">${(cat.lastScore || 0).toFixed(2)}%</span></span><div style="display:flex; gap:10px; align-items:center"><button class="btn btn-main" style="padding:3px 8px; font-size:0.7em" onclick="event.stopPropagation(); window.addTask(${sem.id}, ${course.id}, ${cat.id})">+ Score</button><span class="del-btn" onclick="event.stopPropagation(); window.delCat(${sem.id}, ${course.id}, ${cat.id})">X</span></div></div><div id="t-list-${cat.id}" class="${cat.isCollapsed?'hidden':''}" style="margin-top:10px"></div>`;
                    document.getElementById(`cat-list-${course.id}`).appendChild(catDiv);
                    (cat.tasks || []).forEach(t => {
                        const tr = document.createElement('div'); tr.className = 'task-row';
                        tr.innerHTML = `<input type="text" value="${t.label}" placeholder="Task Name" onchange="window.updateT(${sem.id},${course.id},${cat.id},${t.id},'label',this.value)"><input type="number" value="${t.score}" placeholder="Score" onchange="window.updateT(${sem.id},${course.id},${cat.id},${t.id},'score',this.value)"><input type="number" value="${t.maxScore}" placeholder="Max" onchange="window.updateT(${sem.id},${course.id},${cat.id},${t.id},'maxScore',this.value)"><input type="number" value="${t.scoreIf ?? ''}" placeholder="What If?" onchange="window.updateT(${sem.id},${course.id},${cat.id},${t.id},'scoreIf',this.value)"><button class="btn" style="background:#ffe4e9; color:#e91e63" onclick="window.delTask(${sem.id},${course.id},${cat.id},${t.id})">X</button>`;
                        document.getElementById(`t-list-${cat.id}`).appendChild(tr);
                    });
                });
            });
        });
        document.getElementById('total-courses').innerText = tCourses; 
        document.getElementById('total-credits').innerText = totalCr;
        document.getElementById('cum-gpa').innerText = totalCr>0 ? (totalGPA_Sum/totalCr).toFixed(2) : "0.00";
        document.getElementById('cum-if-gpa').innerText = totalCr>0 ? (totalIfGPA_Sum/totalCr).toFixed(2) : "0.00";
    }
</script>
</body>
</html>
